<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>2XKO Overlay</title>
  <style>
    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      background: transparent;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: 'Swiss 721', Arial, sans-serif;
    }

    #app {
      display: flex;
    }

    #stickWrapper {
      width: 220px;
      height: 220px;
      position: absolute;
      top: 300px;
      left: 60px;
      background: rgba(0,0,0,0.8);
      border-radius: 50%;
    }

    #stickCanvas {
      width: 100%;
      height: 100%;
      display: block;
      background: transparent;
    }

    #joystickHead {
      position: absolute;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: 10px solid #000;
      transform: translate(-50%, -50%) scale(1);
      pointer-events: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 30px;
      transition: left 0.01s, top 0.01s, transform 0.1s;
      background: rgba(160,160,160,1);
    }

    #directionMarkers {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    .marker {
      position: absolute;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(80,80,80,1);
      transform: translate(-50%, -50%);
      transition: all 0.1s;
    }

    .marker.active {
      background: rgba(255,255,255,1);
      width: 20px;
      height: 20px;
    }

    .buttons {
      position: relative;
      width: 300px;
      height: 300px;
    }

    .btn {
      position: absolute;
      width: 90px;
      height: 90px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      text-transform: uppercase;
      transition: 0.05s;
      border-radius: 50%;
      border: 10px solid #000;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      font-family: 'Swiss 721', Arial, sans-serif;
      filter: brightness(0.6);
      overflow: hidden;
      text-align: center;
      white-space: nowrap;
    }

    .btn.active {
      filter: brightness(1);
      transform: scale(1.05);
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="stickWrapper">
      <div id="directionMarkers">
        <div class="marker" id="marker0"></div>
        <div class="marker" id="marker1"></div>
        <div class="marker" id="marker2"></div>
        <div class="marker" id="marker3"></div>
        <div class="marker" id="marker4"></div>
        <div class="marker" id="marker5"></div>
        <div class="marker" id="marker6"></div>
        <div class="marker" id="marker7"></div>
      </div>
      <canvas id="stickCanvas"></canvas>
      <div id="joystickHead"></div>
    </div>

    <div class="controls">
      <div class="buttons" id="buttonGrid"></div>
    </div>
  </div>

  <script>
    // --------------------------
    // CONFIGURATION
    // --------------------------
    const cfg = {
      deadzone: 0.1,
      trail: 15,
      invertY: false,
      buttonStyle: {
        borderColor: '#000',
        activeColor: 'rgba(225,225,225,1)',
        defaultColor: 'rgba(160,160,160,1)'
      },
      buttons: [
        {id:'A', top:240, left:280, label:'T', color:'rgba(200,200,200,1)'},
        {id:'B', top:120, left:280, label:'H', color:'rgba(200,200,200,1)'},
        {id:'X', top:120, left:40,  label:'L', color:'rgba(200,200,200,1)'},
        {id:'Y', top:120, left:160, label:'M', color:'rgba(200,200,200,1)'},
        {id:'LB', top:240, left:400, label:'P', color:'rgba(200,200,200,1)'},
        {id:'RB', top:120, left:400, label:'D', color:'rgba(200,200,200,1)'},
        {id:'LT', top:240, left:40,  label:'S1', color:'rgba(200,200,200,1)'},
        {id:'RT', top:240, left:160, label:'S2', color:'rgba(200,200,200,1)'},
        {id:'LS', top:0, left:-20,   label:'L3', color:'rgba(120,120,120,1)'},
        {id:'RS', top:0, left:460,   label:'R3', color:'rgba(120,120,120,1)'},
        {id:'View', top:0, left:100, label:'-', color:'rgba(120,120,120,1)'},
        {id:'Menu', top:0, left:340, label:'+', color:'rgba(120,120,120,1)'},
      ],
      map: {A:0,B:1,X:2,Y:3,LB:4,RB:5,LT:6,RT:7,View:8,Menu:9,LS:10,RS:11},
      ignoredForJoystick: ['View','Menu','LS','RS'],
      hiddenButtons: []
    };

    // --------------------------
    // BUTTON CREATION & TEXT SHRINK
    // --------------------------
    const buttonGrid = document.getElementById('buttonGrid');
    const btnEls = {};

    cfg.buttons.forEach(b => {
      if (cfg.hiddenButtons.includes(b.id)) return;
      const btn = document.createElement('div');
      btn.className = 'btn';
      btn.dataset.btn = b.id;
      btn.textContent = b.label;
      btn.style.top = b.top + 'px';
      btn.style.left = b.left + 'px';
      btn.style.background = b.color || cfg.buttonStyle.defaultColor;
      btn.style.borderColor = cfg.buttonStyle.borderColor;
      buttonGrid.appendChild(btn);
      btnEls[b.id] = btn;
    });

    function autoShrinkButtonText(btn) {
      const maxWidth = btn.clientWidth;
      btn.style.fontSize = "40px";

      requestAnimationFrame(() => {
        let fontSize = parseInt(window.getComputedStyle(btn).fontSize);
        while (btn.scrollWidth > maxWidth && fontSize > 8) {
          fontSize--;
          btn.style.fontSize = fontSize + "px";
        }
      });
    }

    Object.values(btnEls).forEach(autoShrinkButtonText);

    function setButtonLabel(btn, label) {
      btn.textContent = label;
      btn.style.fontSize = "40px";
      autoShrinkButtonText(btn);
    }

    // --------------------------
    // GAMEPAD LOGIC
    // --------------------------
    let gamepadIndex = null;
    window.addEventListener('gamepadconnected', e => gamepadIndex = e.gamepad.index);
    window.addEventListener('gamepaddisconnected', () => gamepadIndex = null);

    const joystick = document.getElementById('joystickHead');
    const lastPressedTimes = {};

    function updateButtons(pad) {
      if (!pad?.buttons) {
        joystick.style.transform = 'translate(-50%, -50%) scale(1)';
        joystick.textContent = '';
        Object.values(btnEls).forEach(btn => btn.classList.remove('active'));
        return;
      }

      for (const key in btnEls) {
        const idx = cfg.map[key];
        if (idx === undefined) continue;
        const pressed = !!pad.buttons[idx]?.pressed;
        btnEls[key].classList.toggle('active', pressed);
        lastPressedTimes[key] = pressed ? performance.now() : lastPressedTimes[key] || 0;
      }

      let activeBtn = null, latestTime = -1;
      for (const key in lastPressedTimes) {
        if (btnEls[key].classList.contains('active') &&
            !cfg.ignoredForJoystick.includes(key) &&
            lastPressedTimes[key] > latestTime) {
          latestTime = lastPressedTimes[key];
          activeBtn = key;
        }
      }

      if (activeBtn) {
        joystick.style.transform = 'translate(-50%, -50%) scale(1.3)';
        joystick.textContent = btnEls[activeBtn].textContent;
        joystick.style.background = btnEls[activeBtn].style.background;
        joystick.style.color = '#000';
      } else {
        joystick.style.transform = 'translate(-50%, -50%) scale(1)';
        joystick.textContent = '';
        joystick.style.background = 'rgba(215,215,215,1)';
      }
    }

    // --------------------------
    // JOYSTICK MATH
    // --------------------------
    function radialDeadzone(x, y, dz) {
      const mag = Math.hypot(x, y);
      if (mag < dz) return {x:0, y:0};
      const s = (mag - dz) / (1 - dz);
      return {x: x * s / mag, y: y * s / mag};
    }

    function clampCircle(x, y) {
      const mag = Math.hypot(x, y);
      if (mag > 1) return {x: x/mag, y: y/mag};
      return {x, y};
    }

    function getStickXY(pad) {
      if (!pad) return {x:0, y:0};
      let {x, y} = radialDeadzone(pad.axes[0]||0, pad.axes[1]||0, cfg.deadzone);
      const up = pad.buttons[12]?.pressed ? 1 : 0;
      const down = pad.buttons[13]?.pressed ? 1 : 0;
      const left = pad.buttons[14]?.pressed ? 1 : 0;
      const right = pad.buttons[15]?.pressed ? 1 : 0;
      x += right - left;
      y += down - up;
      if (cfg.invertY) y *= -1;
      return clampCircle(x, y);
    }

    let smooth = {x:0, y:0};
    const SMOOTH = 0.95;
    function getSmoothedXY(pad) {
      const t = getStickXY(pad);
      smooth.x += (t.x - smooth.x) * SMOOTH;
      smooth.y += (t.y - smooth.y) * SMOOTH;
      return clampCircle(smooth.x, smooth.y);
    }

    // --------------------------
    // DIRECTION MARKERS
    // --------------------------
    const directions = [
      {x:0,y:-1},{x:1,y:-1},{x:1,y:0},{x:1,y:1},
      {x:0,y:1},{x:-1,y:1},{x:-1,y:0},{x:-1,y:-1}
    ];

    const normDirs = directions.map(d => {
      const mag = Math.hypot(d.x,d.y);
      return {x: d.x/mag, y: d.y/mag};
    });

    const markers = Array.from({length:8}, (_,i) => document.getElementById('marker'+i));

    function getClosestDirection(x, y) {
      const mag = Math.hypot(x, y);
      if (mag < 0.25) return -1;
      let best = -1, bestDot = -Infinity;
      normDirs.forEach((d,i) => {
        const dot = (x*d.x + y*d.y)/mag;
        if (dot > bestDot) { bestDot = dot; best = i; }
      });
      return best;
    }

    function updateMarkers(activeDir) {
      normDirs.forEach((d, i) => {
        markers[i].style.left = 50 + d.x*45 + '%';
        markers[i].style.top = 50 + d.y*45 + '%';
        markers[i].classList.toggle('active', i === activeDir);
      });
    }

    // --------------------------
    // CANVAS TRAIL
    // --------------------------
    const canvas = document.getElementById('stickCanvas');
    const ctx = canvas.getContext('2d');
    let canvasRadius = 0;

    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = rect.height;
      canvasRadius = Math.min(rect.width, rect.height)/2 - 10;
    }

    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    const trail = [];
    function drawTrail(x, y) {
      trail.push({x,y});
      if (trail.length > cfg.trail) trail.shift();

      ctx.clearRect(0,0,canvas.width,canvas.height);
      const cx = canvas.width/2, cy = canvas.height/2;

      for (let i=1; i<trail.length; i++) {
        const p0 = trail[i-1], p1 = trail[i];
        const t = i/trail.length;
        ctx.beginPath();
        ctx.moveTo(cx + p0.x*canvasRadius, cy + p0.y*canvasRadius);
        ctx.lineTo(cx + p1.x*canvasRadius, cy + p1.y*canvasRadius);
        ctx.lineWidth = 20 * (t / t);
        ctx.lineCap = 'round';
        ctx.strokeStyle = 'rgba(200,200,200,1)';
        ctx.shadowBlur = 0;
        ctx.shadowColor = 'rgba(128,128,128,1)';
        ctx.stroke();
      }
    }

    function updateJoystickHead(x, y) {
      joystick.style.left = 50 + x*45 + '%';
      joystick.style.top = 50 + y*45 + '%';
    }

    // --------------------------
    // MAIN LOOP
    // --------------------------
    function loop() {
      const pad = navigator.getGamepads()[gamepadIndex ?? 0];
      const sm = getSmoothedXY(pad);
      drawTrail(sm.x, sm.y);

      const {x, y} = getStickXY(pad);
      updateJoystickHead(x, y);
      updateButtons(pad);
      updateMarkers(getClosestDirection(x, y));

      requestAnimationFrame(loop);
    }

    requestAnimationFrame(loop);
  </script>
</body>
</html>
